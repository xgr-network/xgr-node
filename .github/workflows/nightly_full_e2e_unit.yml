name: Nightly (Integration)

on:
  schedule:
    - cron: "0 2 * * *"  # daily 02:00 UTC
  workflow_dispatch:

concurrency:
  group: nightly-main
  cancel-in-progress: true

jobs:
  nightly:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"
          cache: true

      - name: Go test (unit, full)
        run: |
          set -euo pipefail
          pkgs=$(go list ./... | grep -vE '(/e2e($|/)|/e2e-polybft($|/)|/tests($|/)|/tracker($|/)|/command/rootchain/deploy($|/)|/consensus/polybft($|/)|/state/runtime/evm($|/))')
          go test -count=1 $pkgs

      - name: Build node binary
        run: |
          set -euo pipefail
          mkdir -p bin
          go build -trimpath -o ./bin/xgrchain .
          chmod +x ./bin/xgrchain || true
          file ./bin/xgrchain
          file ./bin/xgrchain | grep -qE 'ELF .* executable' || (echo "ERROR: not an executable" && exit 1)
          ./bin/xgrchain version || ./bin/xgrchain --version || true

          # make it visible for e2e which execs "xgrchain" from PATH
          echo "$PWD/bin" >> "$GITHUB_PATH"
          
      - name: E2E
        run: go test -count=1 -timeout 45m ./e2e/...

      - name: Upload nightly binary
        uses: actions/upload-artifact@v4
        with:
          name: xgrchain-nightly-linux-amd64
          path: ./bin/xgrchain
          retention-days: 14
